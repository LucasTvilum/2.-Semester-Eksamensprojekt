@using Core.Models
@using ClientApp.Service
@inject IWindow windowservice

<div class="row p-3">
    @* Tjekker om data er indlæst, før vi prøver at vise det (for at undgå NullReferenceException) *@
    @if (locations == null || windowTypes == null || !locations.Any() || !windowTypes.Any())
    {
        <p>Loader...</p>
    }
    else
    {
        <div class="locations-container">
            @foreach (var loc in locations)
            {
                <div class="location-box">
                    @* Klik-event der åbner/lukker lokationen og sætter den som aktiv *@
                    <div class="location-header" @onclick="() => SelectLocation(loc)">
                        <span>@loc.Name</span>
                        @* Viser pil op/ned baseret på om lokationen er "åben" i vores HashSet *@
                        <span class="arrow">@(openLocations.Contains(loc) ? "▲" : "▼")</span>
                    </div>

                    @* Betinget rendering: Viser kun indholdet hvis lokationen er i openLocations *@
                    @if (openLocations.Contains(loc))
                    {
                        <div class="location-content">
                            @* Viser et resumé af valgte vinduer for denne specifikke lokation *@
                            @foreach (var wc in windowCounts.Where(x => x.Location == loc && x.Count > 0))
                            {
                                <div class="window-summary">
                                    <img src="@wc.Type.ImagePath"/>
                                    <div class="count">@wc.Count</div>
                                </div>
                            }

                            @if (!windowCounts.Any(x => x.Location == loc && x.Count > 0))
                            {
                                <div class="empty-info">Ingen vinduer tilføjet</div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        @* Knapper til at øge/mindske antallet af vinduer for den valgte lokation *@
        <div class="window-buttons">
            @foreach (var wc in windowCounts.Where(x => x.Location == selectedLocation))
            {
                <div class="window-type-block">
                    <img src="@wc.Type.ImagePath"/>
                    <div>@wc.Type.Name </div>

                    <div class="counter">
                        <button type="button" @onclick="() => Decrease(wc)" disabled="@(wc.Count == 0)">-</button>
                        <span>@wc.Count</span>
                        <button type="button" @onclick="() => Increase(wc)">+</button>
                    </div>
                </div>
            }
        </div>

        @* Beregnet totalpris der opdateres automatisk *@
        <div class="total-box">
            Total: @TotalPrice kr
        </div>

        <div class="booking-actions">
            <button class="btn btn-primary" @onclick="SelectEnkelt">Enkeltbooking</button>
            <button class="btn btn-primary" @onclick="SelectAbonnement">Abonnement</button>
        </div>
    }
</div>

@code {
    [Parameter] public Booking booking { get; set; } = new();
    [Parameter] public EventCallback<string> OnSelectBookingType { get; set; }
    
    private WindowLocation selectedLocation;

    @* 
       Et HashSet er en samling af unikke elementer. 
       Vi bruger det her til at holde styr på, hvilke lokationer der er "foldet ud" i UI.
       Det er hurtigere end en Liste til at tjekke om et element findes (.Contains).
    *@
    private HashSet<WindowLocation> openLocations = new();

    @* Hjælpe-liste til at styre optællingen i UI *@
    private List<WindowCount> windowCounts = new();

    @* En Expression-bodied property der summerer prisen på alle vinduer i bookingen *@
    private decimal TotalPrice => booking.Windows.Sum(w => w.Price);

    private List<WindowType> windowTypes = new();
    private List<WindowLocation> locations = new();

    protected override async Task OnInitializedAsync()
    {
        // Henter stamdata fra databasen via servicen
        windowTypes = await windowservice.GetAllWindowTypes();
        locations = await windowservice.GetAllWindowLocations();

        selectedLocation = locations.FirstOrDefault();

        // LINQ: Kombinerer alle typer med alle lokationer (Cross Join)
        // så vi har en tæller klar til hver eneste kombination.
        windowCounts = (
            from type in windowTypes
            from loc in locations
            select new WindowCount
            {
                Type = type,
                Location = loc,
                Count = 0
            }).ToList();
    }

    private void SelectLocation(WindowLocation loc)
    {
        // Toggle-logik: Hvis den findes, fjern den (luk). Hvis ikke, tilføj den (åben).
        if (openLocations.Contains(loc))
            openLocations.Remove(loc);
        else
            openLocations.Add(loc);

        selectedLocation = loc;
    }

    private void Increase(WindowCount wc)
    {
        wc.Count++;

        // Opretter et nyt Window-objekt og beregner prisen med det samme
        var w = new Window
        {
            Type = wc.Type,
            Location = wc.Location,
            Price = new Window { Type = wc.Type, Location = wc.Location }.CalculatePrice()
        };

        booking.Windows.Add(w);
    }

    private void Decrease(WindowCount wc)
    {
        if (wc.Count <= 0) return;

        wc.Count--;

        // Finder det sidste vindue af denne type i bookingen og fjerner det
        var toRemove = booking.Windows.LastOrDefault(w =>
            w.Type.Id == wc.Type.Id &&
            w.Location.Id == wc.Location.Id);

        if (toRemove != null)
            booking.Windows.Remove(toRemove);
    }

    @* Intern klasse til at holde styr på UI-tællere *@
    public class WindowCount
    {
        public WindowType Type { get; set; }
        public WindowLocation Location { get; set; }
        public int Count { get; set; }
    }

    @* Sender besked tilbage til forældre-komponenten om valg af booking-type *@
    private Task SelectEnkelt() => OnSelectBookingType.InvokeAsync("Enkelt");
    private Task SelectAbonnement() => OnSelectBookingType.InvokeAsync("Abonnement");
}