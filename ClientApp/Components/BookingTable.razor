@using ClientApp.Service
@using Core.Models
@inject UserState userState
@inject IWorkTask workTaskService
@inject IBooking bookingService
@inject IWindow windowService


<div class="page-wrapper mybookings-page">

<div class="page-header">
    <h1>Bookinger</h1>
    <p class="page-subtitle">
        Her kan du se, redigere og afmelde kundernes bookinger
    </p>
</div>

<!-- RESTEN AF DIN KODE KOMMER HER -->
@if (!userState.IsWorker)
{
    <p>Kun for medarbejdere</p>
}

<table class="table tvilum-table">
    <thead class="table-light">
    <tr>
        <th>Booking type</th>
        <th>Dag/Dato</th>
        <th>Udenfor Interval</th>
        <th>Indenfor Interval</th>
        <th>Kunde Note</th>
        <th>Vinduespudser Note</th>
        <th>Samlet Pris</th>
        <th>Status</th>
        <th>Vinduer</th>
        <th>Bookingstatus</th>
    </tr>
    </thead>

    <tbody>
    @if (bookinglist != null)
    {
        @foreach (var booking in bookinglist)
        {
            <tr>
                <td>@booking.TypeBooking</td>
                @if (booking.TypeBooking == Booking.BookingType.Abonnement)
                {
                    <td>@booking.Day</td>
                }
                else
                {
                    <td>@booking.Date.ToString("dd.MM.yyyy")</td>
                }
                @if (booking.OutdoorInterval != 0){
                    <td>@booking.OutdoorInterval</td>
                }
                else
                {
                    <td>-</td>
                }
                @if (booking.InsideJob == true){
                    <td>@booking.InsideInterval</td>
                }
                else
                {
                    <td>-</td>
                }
                <td>@booking.NotesCustomer</td>
                <td>@booking.NotesWindowCleaner</td>
                <td>@(booking.Windows?.Sum(w => w.Price) ?? 0)</td>
                <td>
                    <span class="status-badge @GetStatusClass(booking.Status)">
                        @booking.Status
                    </span>
                </td>

                <td>
                    <button class="btn btn-sm btn-primary"
                            @onclick="() => OpenModalWindows(booking)">
                        Vis Vinduer
                    </button>
                </td>

                <td>
                    <button class="btn btn-sm btn-warning"
                            @onclick="() => OpenModalBooking(booking)">
                        Ændrer Status
                    </button>
                </td>
            </tr>
        }
    }
    </tbody>
</table>

<!-- WINDOWS MODAL -->
@if (showModalWindows)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Vinduer</h5>
                    <button class="btn-close" @onclick="CloseModalWindows"></button>
                </div>
                <div class="modal-body">
                    <WindowSelector booking="selectedBooking" OnWindowsUpdated="CloseModalWindows" />
                </div>
            </div>
        </div>
    </div>
}

@if (showModalBooking)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Vinduer</h5>
                    <button class="btn-close" @onclick="CloseModalBooking"></button>
                </div>
                <div class="modal-body">
                    @if (selectedBooking.Status != null)
                    {
                        <h2>Vinduer</h2>
                        <h1>@selectedBooking.Status</h1>
                        <div class="col-md-12 mb-3">
                            <label for="Category">Booking Status</label>
                            <InputSelect id="Category" @bind-Value="selectedstatus">
                                @foreach (var cat in statuscategories)
                                {
                                    <option value="@cat">@cat</option>
                                }
                            </InputSelect>
                        </div>
                    }
                </div>
                <button class="btn btn-success" @onclick="CloseModalBookingStatusUpdate">Accept</button>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModalBooking">Close</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public List<Booking> bookinglist { get; set; } = new();

    private string newWindowTypeId;
    private string newWindowLocationId;

    private List<WindowType> windowtypecategories = new List<WindowType>();
    private List<WindowLocation> windowlocationcategories = new List<WindowLocation>();

    
    private Booking[] bookingArray;

    private List<Window> windowlist = new List<Window>();
    private Window[] windowArray;

    private bool showModalWindows = false;
    private bool showModalBooking = false;
    private Booking selectedBooking;
    private string selectedstatus = "";
    
    private List<string> statuscategories = new List<string> { "Godkendt", "Afventer","Afvist","Aktiv",};

    private void OpenModalWindows(Booking booking)
    {
        selectedBooking = booking;
        showModalWindows = true;
    }

    private void CloseModalWindows()
    {
        showModalWindows = false;
    }

    private void OpenModalBooking(Booking booking)
    {
        selectedBooking = booking;
        selectedstatus = booking.Status;
        showModalBooking = true;
    }

    private void CloseModalBooking()
    {
        showModalBooking = false;
    }

    private async Task CloseModalBookingStatusUpdate()
    {
        showModalBooking = false;
        
        // Bestem status ud fra valgt status i dropdown
        if (selectedstatus == "Godkendt")
        {
            selectedBooking.Status = "Aktiv";   // vi går direkte til Aktiv
        }
        else if (selectedstatus == "Afvist")
        {
            selectedBooking.Status = "Inaktiv";
        }
        else
        {
            // Hvis Afmeldt
            selectedBooking.Status = selectedstatus;
        }

        // Gem booking i databasen med den nye status
        await bookingService.UpdateBooking(selectedBooking);

        // Hvis booking er AKTIV → opret arbejdsopgaver
        if (selectedBooking.Status == "Aktiv")
        {
            if (selectedBooking.TypeBooking == Booking.BookingType.Abonnement)
            {
                Console.WriteLine("Adding subscription work tasks");
                await workTaskService.AddSubscription(selectedBooking);
            }
            else if (selectedBooking.TypeBooking == Booking.BookingType.EnkeltBooking)
            {
                Console.WriteLine("Adding single booking work task");
                await workTaskService.AddSingleBooking(selectedBooking);
            }
        }
        // Hvis booking bliver afmledt eller inaktiv → slet arbejdsopgaver
        else if (selectedBooking.Status == "Afmeldt" || selectedBooking.Status == "Inaktiv")
        {
            Console.WriteLine("Deleting all worktasks for booking");
            await workTaskService.DeleteAllWorkTaskFromBookingId(selectedBooking.Id);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        windowtypecategories = await windowService.GetAllWindowTypes();
        windowlocationcategories = await windowService.GetAllWindowLocations();

        windowArray = await windowService.GetAll();
        windowlist = windowArray.ToList();
       
        foreach (var VARIABLE in bookinglist)
        {
            Console.WriteLine(VARIABLE.Id);
        }
    }
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Aktiv" => "status-active",
            "Godkendt" => "status-approved",
            "Afventer" => "status-pending",
            "Afvist" => "status-denied",
            "Inaktiv" => "status-cancelled",
            "Afmeldt" => "status-cancelled",
            _ => "status-default"
        };
    }
}
</div>

