@page "/PriceCalculator"
@using Core.Models
@using ClientApp.Components
@using ClientApp.Service
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IBooking bookingService
@inject NavigationManager nav
@inject IWindow windowService
@inject UserState userState
@inject NavigationManager navigationManager


<div class="price-header">
    <h3 class="price-title">Pris beregner</h3>
    <p class="price-subtitle">
        Vælg en etage, og tilføj derefter de vinduer, der hører til etagen.
        Prisen opdateres automatisk.
    </p>
</div>


<div class="price-calculator-wrapper">
    <WindowPriceCalculator Booking="@booking"
                           OnSelectBookingType="HandleBookingType" />
</div>
@if (showSubscriptionModal)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5>Opret abonnement</h5>
                    <button class="btn-close" @onclick="() => showSubscriptionModal = false"></button>
                </div>

                <div class="modal-body">

                    <EditForm Model="@booking" OnValidSubmit="@HandleSubscriptionSubmit" class="row p-3">
                        <DataAnnotationsValidator/>
                        <ValidationSummary/>

                        <div class="col-md-12 mb-3">
                            <label>Uge interval udenfor:</label>
                            <InputSelect @bind-Value="booking.OutdoorInterval">
                                @foreach (var cat in intervalcategories)
                                {
                                    <option value="@cat">@cat</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="col-md-12 mb-3">
                            <label>Uge interval indenfor:</label>
                            <InputSelect @bind-Value="booking.InsideInterval">
                                @foreach (var cat in intervalcategories)
                                {
                                    <option value="@cat">@cat</option>
                                }
                            </InputSelect>
                        </div>

                        @if (booking.InsideJob)
                        {
                            <div class="col-md-12 mb-3">
                                <label>Uge interval indenfor:</label>
                                <InputSelect @bind-Value="booking.InsideInterval">
                                    @foreach (var cat in intervalcategories)
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                </InputSelect>
                            </div>
                        }

                        <div class="col-md-12 mb-3">
                            <label>Dag:</label>
                            <InputSelect @bind-Value="booking.Day">
                                @foreach (var d in daycategories)
                                {
                                    <option value="@d">@d</option>
                                }
                            </InputSelect>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label>Noter</label>
                            <InputText class="form-control" @bind-Value="booking.NotesCustomer" />
                        </div>
                        

                        <button type="submit" class="btn btn-primary">Opret abonnement</button>
                    </EditForm>

                </div>

            </div>
        </div>
    </div>
}

@if (showOneTimeModal)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5>Enkeltbooking</h5>
                    <button class="btn-close" @onclick="() => showOneTimeModal = false"></button>
                </div>

                <div class="modal-body">

                    <KalenderComponentv2 @bind-SelectedDay="booking.Day" @bind-SelectedDate="booking.Date"/>

                    <EditForm Model="@booking" OnValidSubmit="@HandleOneTimeSubmit" class="mt-3">
                        <DataAnnotationsValidator/>
                        <ValidationSummary/>
                        <div class="mb-3">
                            <label>Noter</label>
                            <InputText class="form-control" @bind-Value="booking.NotesCustomer"/>
                        </div>
                        <button type="submit" class="btn btn-primary">Opret enkeltbooking</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}
@if (userState.IsWorker)
{
    <div class="admin-action">
        <button class="btn btn-secondary" @onclick="OpenAdminModal">
            Admin: Rediger vinduer & priser
        </button>
    </div>
}
@if (showAdminModal)
{
    <AdminModal Show="showAdminModal" OnClose="@CloseAdminModal" />
}

@code {
    private Booking booking = new();
    private bool showOneTimeModal = false;
    private bool showSubscriptionModal = false;
    private List<int> intervalcategories = new() { 2, 4, 8, 12, 24 };
    private List<string> daycategories = new() { "Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag", "Lørdag", "Søndag" };
    private DateTime selectedDate = new DateTime();
    bool showAdminModal = false;
    
    private async Task HandleSubscriptionSubmit()
    {
        // hent bruger OG sæt customer id FØR du sender til backend
        var user = await localStorage.GetItemAsync<User>("currentUser");
        booking.CustomerId = user?.Id;

        booking.TypeBooking = Booking.BookingType.Abonnement;
        booking.Status = "afventer";
        
        //ikke await så vi ik bliver sendt videre før booking er gennemført
        bookingService.Add(booking);
        
        // ryd pending og luk modal
        await localStorage.RemoveItemAsync("pendingBooking");
        navigationManager.NavigateTo("/BookingConfirmation");
        showSubscriptionModal = false;
        booking = new Booking();
    }

    private async Task HandleOneTimeSubmit()
    {
        var user = await localStorage.GetItemAsync<User>("currentUser");
        booking.CustomerId = user?.Id;

        booking.TypeBooking = Booking.BookingType.EnkeltBooking;
        booking.Status = "afventer";
        
        booking.Date = DateTime.SpecifyKind(booking.Date, DateTimeKind.Utc);

        Console.WriteLine(booking.Date);

        //ikke await så vi ik bliver sendt videre før booking er gennemført
        bookingService.Add(booking);
        
        await localStorage.RemoveItemAsync("pendingBooking");
        navigationManager.NavigateTo("/BookingConfirmation");
        showOneTimeModal = false;
        booking = new Booking();
    }
    
    protected override async Task OnInitializedAsync()
    {
        // indlæs eventuel pending booking
        var saved = await localStorage.GetItemAsync<Booking>("pendingBooking");
        if (saved != null)
            booking = saved;

        // check om vi blev sendt hertil pga. redirect fra Register
        var returnType = await localStorage.GetItemAsync<string>("returnType");
        if (!string.IsNullOrEmpty(returnType))
        {
            // fjern returnType så vi ikke genåbner modal ved reload
            await localStorage.RemoveItemAsync("returnType");

            if (returnType == "Enkelt")
            {
                // lav ny booking-objekt med nyt id men behold windows/pris
                booking = new Booking { Windows = booking.Windows, Price = booking.Price, InsideJob = booking.InsideJob };
                showOneTimeModal = true;
            }
            else if (returnType == "Abonnement")
            {
                booking = new Booking { Windows = booking.Windows, Price = booking.Price, InsideJob = booking.InsideJob };
                showSubscriptionModal = true;
            }
        }
    }

    private async Task HandleBookingType(string type)
    {
        var user = await localStorage.GetItemAsync<User>("currentUser");

        if (user == null)
        {
            // gem booking før redirect
            await localStorage.SetItemAsync("pendingBooking", booking);
            await localStorage.SetItemAsync("returnType", type);

            nav.NavigateTo("/Register?returnUrl=PriceCalculator");
            return;
        }

        if (type == "Enkelt")
            showOneTimeModal = true;

        if (type == "Abonnement")
            showSubscriptionModal = true;
    }

    private void OpenAdminModal()
    {
        showAdminModal = true;
    }

    private void CloseAdminModal()
    {
        showAdminModal = false;
    }
    
    private bool showSuccessOverlay = false;

    void GoToHome() => navigationManager.NavigateTo("/Home");
    void GoToMyBookings() => navigationManager.NavigateTo("/mybookings");

}

