@using System.Diagnostics
@using Core.Models
@using ClientApp.Service
@using Microsoft.AspNetCore.Components.Forms

@inject WindowService windowService
@page "/PriceCalculator"
<h3>Price Calculator</h3>

    
<EditForm Model="@booking"  class="row p-3">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div style="margin-bottom:20px;">
        <button @onclick="() => SelectLocation(WindowLocation.StueEtage)"
                style="@(selectedLocation == WindowLocation.StueEtage ? "font-weight:bold" : "")">
            Stueetage
        </button>

        <button @onclick="() => SelectLocation(WindowLocation.FoersteEtage)"
                style="@(selectedLocation == WindowLocation.FoersteEtage ? "font-weight:bold" : "")">
            1. etage
        </button>

        <button @onclick="() => SelectLocation(WindowLocation.Indenfor)"
                style="@(selectedLocation == WindowLocation.Indenfor ? "font-weight:bold" : "")">
            Indenfor
        </button>

        <button @onclick="() => SelectLocation(WindowLocation.Kaelder)"
                style="@(selectedLocation == WindowLocation.Kaelder ? "font-weight:bold" : "")">
            Kælder
        </button>
    </div>
    
    <h3>@Window.GetLabelLocation(selectedLocation)</h3>

    @foreach (var w in booking.Windows.Where(x => x.Location == selectedLocation))
    {
        <span>@Window.GetLabelType(w.Type)</span>
    }
    
    <div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:30px;">
        @foreach (var wc in windowCounts.Where(x => x.Location == selectedLocation))
        {
            <div style="text-align:center; width:120px;">
                <img src="@Window.GetImage(wc.Type)" style="width:80px; height:auto;" />
                <div>@Window.GetLabelType(wc.Type)</div>
                
                <div style="margin-top:5px;">
                    <button type="button" @onclick="() => Decrease(wc)" disabled="@(wc.Count == 0)">-</button>
                    <span style="margin:0 10px;">@wc.Count</span>
                    <button type="button"@onclick="() => Increase(wc)">+</button>
                </div>
            </div>
        }
    </div>
    
</EditForm> 
<h3>Total: @totalPrice kr</h3>
    
@foreach (WindowLocation loc in Enum.GetValues(typeof(WindowLocation)))
{
    <h4>@Window.GetLabelLocation(loc)</h4>
    @foreach (var wc in windowCounts.Where(x => x.Location == loc && x.Count > 0))
    {
        <div>
            @Window.GetLabelType(wc.Type): @wc.Count stk
        </div>
    }
}

    @code {
        private decimal totalPrice => booking.Windows.Sum(w => w.Price);
        private Booking booking = new();
        
        protected override void OnInitialized()
        {
            if (windowCounts == null || windowCounts.Count == 0)
            {
                windowCounts =
                    (from type in Enum.GetValues(typeof(WindowType)).Cast<WindowType>()
                        from loc in Enum.GetValues(typeof(WindowLocation)).Cast<WindowLocation>()
                        select new WindowCount
                        {
                            Type = type,
                            Location = loc,
                            Count = 0
                        }).ToList();
            }
            
        }
        public class WindowCount
        {
            public WindowType Type { get; set; }
            public WindowLocation Location { get; set; }
            public int Count { get; set; }
        }

        private List<WindowCount> windowCounts = new();

        private void Increase(WindowCount wc)
        {
            wc.Count++;
            var w = new Window
            {
                Type = wc.Type,
                Location = wc.Location
            };
            w.Price = w.CalculatePrice();
            booking.Windows.Add(w);
            StateHasChanged();
      
        }

        private void Decrease(WindowCount wc)
        {
            if (wc.Count <= 0) return;
            
                wc.Count--;

                var toRemove = booking.Windows
                    .LastOrDefault(w => w.Type == wc.Type && w.Location == wc.Location);

                if (toRemove != null)
                    booking.Windows.Remove(toRemove);
                
        } 
        private WindowLocation selectedLocation = WindowLocation.StueEtage;

        private void SelectLocation(WindowLocation loc)
        {
            selectedLocation = loc;
         
}

}
