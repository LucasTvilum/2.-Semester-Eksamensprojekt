@page "/CustomerList"
@using ClientApp.Components
@using ClientApp.Service
@using Core.Models
@inject IBooking bookingService
@inject IUser userService
@inject IWindow windowService
@inject IWorkTask workTaskService
@inject UserState userState

<h3>Kundeliste</h3>

@if (!userState.IsWorker)
{
    <p>Du har ikke adgang til denne side.</p>
    return;
}

@if (customers == null)
{
    <p>Henter kunder...</p>
}
else
{
    <input type="text" @bind="searchText" placeholder="Søg efter kunde..." class="form-control" />

    <br />

    <table class="table table-striped">
        <thead>
        <tr>
            <th>Navn</th>
            <th>Email</th>
            <th>Telefon</th>
            <th>Adresse</th>
            <th>Information</th>
            <th>Slet</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var c in FilteredCustomers)
        {
            <tr>
                <td>@c.Name</td>
                <td>@c.Mail</td>
                <td>@c.PhoneNumber</td>
                <td>@c.Address</td>

                <td>
                    <!-- NOTE: OpenBookingModal is async now -->
                    <button class="btn btn-info btn-sm" @onclick="() => OpenBookingModalAsync(c)">
                        Information
                    </button>
                </td>

                <td>
                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteCustomer(c.Id)">
                        Slet
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<!-- MAIN BOOKING MODAL -->
@if (showBookingModal)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h5>Bookings for @selectedCustomer?.Name</h5>
                    <button class="btn-close" @onclick="CloseBookingModal"></button>
                </div>

                <div class="modal-body">
                    @if (!selectedCustomerBookings.Any())
                    {
                        <p>Ingen bookings fundet for denne kunde.</p>
                    }
                    else
                    {
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Dag</th>
                                    <th>InsideInterval</th>
                                    <th>InsideJob</th>
                                    <th>Noter (kunde)</th>
                                    <th>Noter (pudser)</th>
                                    <th>OutdoorInterval</th>
                                    <th>Pris</th>
                                    <th>Status</th>
                                    <th>Vinduer</th>
                                    <th>Ændr status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in selectedCustomerBookings)
                                {
                                    <tr>
                                        <td>@booking.TypeBooking</td>
                                        <td>@booking.Day</td>
                                        <td>@booking.InsideInterval</td>
                                        <td>@booking.InsideJob</td>
                                        <td>@booking.NotesCustomer</td>
                                        <td>@booking.NotesWindowCleaner</td>
                                        <td>@booking.OutdoorInterval</td>
                                        <td>@booking.Price</td>
                                        <td>@booking.Status</td>

                                        <td>
                                            <button class="btn btn-primary btn-sm"
                                                    @onclick="() => OpenModalWindows(booking)">
                                                Vinduer
                                            </button>
                                        </td>

                                        <td>
                                            <button class="btn btn-warning btn-sm"
                                                    @onclick="() => OpenModalBooking(booking)">
                                                Status
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseBookingModal">Luk</button>
                </div>

            </div>
        </div>
    </div>
}

<!-- WINDOWS MODAL -->
@if (showModalWindows)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Vinduer</h5>
                    <button class="btn-close" @onclick="CloseModalWindows"></button>
                </div>
                <div class="modal-body">
                    <WindowSelector booking="selectedBooking" OnWindowsUpdated="CloseModalWindows" />
                </div>
            </div>
        </div>
    </div>
}


<!-- STATUS MODAL -->
@if (showModalBooking)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5>Status ændring</h5>
                    <button class="btn-close" @onclick="CloseModalBooking"></button>
                </div>

                <div class="modal-body">
                    <p><strong>Nuværende:</strong> @selectedBooking?.Status</p>

                    <label>Ny status:</label>
                    <InputSelect @bind-Value="selectedstatus" class="form-select">
                        @foreach (var s in statuscategories)
                        {
                            <option value="@s">@s</option>
                        }
                    </InputSelect>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" @onclick="CloseModalBookingStatusUpdate">Gem</button>
                    <button class="btn btn-secondary" @onclick="CloseModalBooking">Luk</button>
                </div>
            </div>
        </div>
    </div>
}

@code {

    // ------------------- DATA -------------------
    private List<Customer> customers = new();
    private List<Booking> bookings = new();
    private Customer? selectedCustomer;
    private List<Booking> selectedCustomerBookings = new();

    private List<WindowType> windowtypecategories = new();
    private List<WindowLocation> windowlocationcategories = new();
    private Window[] windowArray;
    private List<Window> windowlist = new();
    private string searchText = "";
    private Booking selectedBooking;
    private string selectedstatus = "";
    private string newWindowTypeId;
    private string newWindowLocationId;

    private bool showBookingModal = false;
    private bool showModalWindows = false;
    private bool showModalBooking = false;

    private List<string> statuscategories = new()
    {
        "Godkendt", "Afventer", "Afvist", "Aktiv"
    };


    
    protected override async Task OnInitializedAsync()
    {
        customers = await userService.GetCustomers();

        windowtypecategories = await windowService.GetAllWindowTypes();
        windowlocationcategories = await windowService.GetAllWindowLocations();
        
        bookings = (await bookingService.GetAll()).ToList();
        
    }

   
    private IEnumerable<Customer> FilteredCustomers =>
        string.IsNullOrWhiteSpace(searchText)
            ? customers
            : customers.Where(c =>
                (c.Name ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (c.Mail ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (c.PhoneNumber ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (c.Address ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase)
            );

    
    private async Task DeleteCustomer(string id)
    {
        await userService.Delete(id);
        customers = customers.Where(c => c.Id != id).ToList();
    }
    
    private async Task OpenBookingModalAsync(Customer customer)
    {
        selectedCustomer = customer;
        bookings = (await bookingService.GetAll()).ToList();

        selectedCustomerBookings = bookings
            .Where(b => b.CustomerId == customer.Id)
            .ToList();

        showBookingModal = true;
        StateHasChanged();
    }

    private void CloseBookingModal()
    {
        showBookingModal = false;
    }
    
    private void OpenModalWindows(Booking booking)
    {
        selectedBooking = booking;
        showModalWindows = true;
    }

    private void CloseModalWindows()
    {
        showModalWindows = false;
    }

    private void AddWindow()
    {
        if (string.IsNullOrWhiteSpace(newWindowTypeId) || string.IsNullOrWhiteSpace(newWindowLocationId))
            return;

        var type = windowtypecategories.FirstOrDefault(t => t.Id == newWindowTypeId);
        var loc = windowlocationcategories.FirstOrDefault(l => l.Id == newWindowLocationId);

        if (type == null || loc == null)
            return;

        if (selectedBooking.Windows == null)
            selectedBooking.Windows = new List<Window>();

        selectedBooking.Windows.Add(new Window
        {
            Type = type,
            Location = loc
        });

        // clear selects
        newWindowTypeId = null;
        newWindowLocationId = null;
    }

    private void DeleteWindow(Window window)
    {
        selectedBooking.Windows?.Remove(window);
    }

    private async Task SaveWindows()
    {
        // update booking in DBs
        await bookingService.UpdateBooking(selectedBooking);

        // after saving, refresh server copy of bookings and the selected customer's bookings
        await RefreshSelectedCustomerBookings();

        showModalWindows = false;
    }

    
    private void OpenModalBooking(Booking booking)
    {
        selectedBooking = booking;
        selectedstatus = booking.Status;
        showModalBooking = true;
    }

    private void CloseModalBooking()
    {
        showModalBooking = false;
    }

    private async Task CloseModalBookingStatusUpdate()
    {
        showModalBooking = false;

        // 1) update booking status in DB
        selectedBooking.Status = selectedstatus;
        await bookingService.UpdateBooking(selectedBooking);

        // 2) perform any post-update tasks (AddSubscription/AddSingleBooking)
        if (selectedstatus == "Godkendt" &&
            selectedBooking.TypeBooking == Booking.BookingType.Abonnement)
        {
           
            selectedBooking.Status = "Aktiv";
            await bookingService.UpdateBooking(selectedBooking);
            await workTaskService.AddSubscription(selectedBooking);

        }
        else if (selectedstatus == "Godkendt" &&
                 selectedBooking.TypeBooking == Booking.BookingType.EnkeltBooking)
        {
            selectedBooking.Status = "Aktiv";
            await workTaskService.AddSingleBooking(selectedBooking);
        }

        if (selectedstatus == "Afvist")
        {
            selectedBooking.Status = "Inaktiv";
        }
        
        await RefreshSelectedCustomerBookings();
    }
    

    private async Task RefreshSelectedCustomerBookings()
    {
        // reload all bookings from DB
        bookings = (await bookingService.GetAll()).ToList();

        if (selectedCustomer != null)
        {
            selectedCustomerBookings = bookings
                .Where(b => b.CustomerId == selectedCustomer.Id)
                .ToList();
        }

        StateHasChanged();
    }

}
