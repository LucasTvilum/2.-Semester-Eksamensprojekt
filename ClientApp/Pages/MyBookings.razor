@page "/mybookings"
@using ClientApp.Service
@using Core.Models
@inject UserState userState

@* 
   MYBOOKINGS SIDE
   Denne side er kundens personlige dashboard. Formålet er at give kunden overblik over deres 
   vinduespudsnings-aftaler og give dem mulighed for at interagere med dem (afmelde/redigere).
*@

<div class="page-wrapper mybookings-page">

@* SIKKERHEDSTJEK: Vi viser kun indholdet, hvis brugeren er logget ind via userState *@
@if (!userState.IsLoggedIn) 
{
    <p>Du skal være logget ind for at se dine bookinger</p>
}
else
{
    @* LOGIK: Hvis kunden slet ikke har nogen bookinger i systemet endnu *@
    @if (!subscriptionBookings.Any() && !singleBookings.Any())
    {
        <h3>Bookinger:</h3>
        <p>Du har ingen bookinger tilgængelige endnu.</p>
    }
    else
    {
        @* HEADER SEKTION: Dynamisk titel og infoknap *@
        <div class="d-flex justify-content-between align-items-center mb-3">
        @if (showSubscription)
        {
            <h3>Abonnementer</h3>
        }
        else
        {
            <h3>Dine bookinger</h3>
        }
        @* Knappen åbner en modal med kontaktoplysninger på pudseren *@
        <button class="btn btn-info" @onclick="() => showContactInfo = true">
            Info
        </button>
        </div>

        @* HOVEDTABEL: Viser enten abonnementer eller enkeltbookinger baseret på 'showSubscription' *@
        <table class="table tvilum-table">
            <thead class="table-light">
            <tr>
                @if (showSubscription)
                {
                    <th>Dag</th>
                    <th>Næste pudsedato</th>
                }
                else
                {
                    <th>Dato</th>
                }
                <th>Pris</th>
                <th>Status</th>
                @if (showSubscription)
                {
                    <th>Indenfor Uge Interval</th>
                    <th>Udenfor Uge Interval</th>
                }
                <th>Dine noter</th>
                <th>Vinduer</th>
                @if (showSubscription)
                {
                    <th>Rediger</th> 
                }
                <th>Afmeld</th> 
            </tr>
            </thead>

            <tbody>
            @if (showSubscription)
            {
                @* LOOP: Gennemgår alle aktive abonnementer *@
                @foreach (var booking in subscriptionBookings)
                {
                    <tr>
                        @* Vi formaterer datoer til dansk format (dd-MM-yyyy) *@
                        <td>@booking.Date.ToString("dddd", new System.Globalization.CultureInfo("da-DK"))</td>
                        <td>@booking.Date.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>

                        @* PRIS-LOGIK: Vi bruger LINQ Sum() her, fordi databasen kun gemmer prisen på 
                           de enkelte Window-objekter. Dette sikrer at kunden ser den rigtige pris. *@
                        <td>@(booking.Windows?.Sum(w => w.Price) ?? 0) kr.</td>
                        
                        <td>
                            @* Status-badge med dynamisk CSS klasse (f.eks. grøn for aktiv) *@
                            <span class="status-badge @GetStatusClass(booking.Status)">
                                @booking.Status
                            </span>
                        </td>

                        @if (showSubscription)
                        {
                            <td>@booking.InsideInterval</td>
                            <td>@booking.OutdoorInterval</td>
                        }
                        <td>@booking.NotesCustomer</td>
                        <td>
                            @* Åbner vindues-detaljer i en modal *@
                            <button class="btn btn-sm btn-primary" @onclick="() => OpenModalWindows(booking)">
                                Vis Vinduer
                            </button>
                        </td>
                        @if (showSubscription)
                        {
                            <td>
                                @* Kun aktive abonnementer kan ændre ugedag *@
                                @if (booking.Status == "Aktiv")
                                {
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenChangeDayModal(booking)">
                                        Rediger
                                    </button>
                                }
                            </td>
                        }

                        <td>
                            @if (booking.Status == "Aktiv")
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => OpenCancelModal(booking)">
                                    Afmeld
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                @* LOOP: Gennemgår alle aktive enkeltbookinger *@
                @foreach (var booking in singleBookings)
                {
                    <tr>
                        <td>@booking.Date.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>
                        <td>@(booking.Windows?.Sum(w => w.Price) ?? 0) kr.</td>
                        <td>
                            <span class="status-badge @GetStatusClass(booking.Status)">
                                @booking.Status
                            </span>
                        </td>
                        <td>@booking.NotesCustomer</td>
                        <td>
                            <button class="btn btn-sm btn-primary" @onclick="() => OpenModalWindows(booking)">
                                Vis Vinduer
                            </button>
                        </td>
                        <td>
                            @if (booking.Status == "Aktiv" || booking.Status == "Godkendt" || booking.Status == "Afventer")
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => OpenCancelModal(booking)">
                                    Afbestil
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    }
}

@* HISTORIK SEKTION: Viser afsluttede eller annullerede forløb *@
<h3 class="mt-4">Tidligere bookinger</h3>

@if (previousBookings == null || !previousBookings.Any())
{
    <p>Du har ingen tidligere bookinger.</p>
}
else
{
    <table class="table tvilum-table">
        <thead class="table-light">
        <tr>
            <th>Dato</th>
            <th>Pris</th>
            <th>Status</th>
            <th>Indenfor Uge Interval</th>
            <th>Udenfor Uge Interval</th>
            <th>Kunde kommentar</th>
            <th>Vinduer</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var booking in previousBookings)
        {
            <tr>
                <td>@booking.Date.ToString("dddd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>
                <td>@(booking.Windows?.Sum(w => w.Price) ?? 0) kr.</td>
                <td>
                    <span class="status-badge @GetStatusClass(booking.Status)">
                        @booking.Status
                    </span>
                </td>
                <td>@booking.InsideInterval</td>
                <td>@booking.OutdoorInterval</td>
                <td>@booking.NotesCustomer</td>
                <td>
                    <button class="btn btn-sm btn-primary" @onclick="() => OpenModalWindows(booking)">
                        Vis Vinduer
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@* MODAL: VIS VINDUER 
   Viser præcis hvilke vinduer og placeringer der er valgt for den specifikke booking. *@
@if (showModalWindows)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Vinduer i denne booking</h5>
                    <button class="btn-close" @onclick="CloseModalWindows"></button>
                </div>
                <div class="modal-body">
                    @if (selectedBooking.Windows != null)
                    {
                        <ul>
                            @foreach (var window in selectedBooking.Windows)
                            {
                                <li>@window.Type.Name - @window.Location.Name (@window.Price kr.)</li>
                            }
                        </ul>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModalWindows">Luk</button>
                </div>
            </div>
        </div>
    </div>
}

@* MODAL: ANNULLERING
   En sikkerheds-dialog der spørger kunden om de er sikre før vi ændrer status til 'Afmeldt'. *@
@if (showCancelModal)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>@(bookingToCancel?.TypeBooking == Booking.BookingType.Abonnement ? "Afmeld abonnement" : "Afbestil booking")</h5>
                    <button class="btn-close" @onclick="CloseCancelModal"></button>
                </div>
                <div class="modal-body">
                    <p>Er du sikker på, at du vil afmelde din aftale hos Tvilum?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseCancelModal">Fortryd</button>
                    <button class="btn btn-danger" @onclick="ConfirmCancelSubscription">Bekræft</button>
                </div>
            </div>
        </div>
    </div>
}

@* MODAL: REDIGER DAG
   Bruger InputSelect så kunden kan vælge en ny fast ugedag til deres abonnement. *@
@if (showChangeDayModal && bookingToChangeDay != null)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Skift fast ugedag</h5>
                    <button class="btn-close" @onclick="CloseChangeDayModal"></button>
                </div>
                <div class="modal-body">
                    <label>Vælg din foretrukne dag:</label>
                    <InputSelect @bind-Value="selectedDayOfWeek" class="form-select">
                        @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                        {
                            <option value="@day">@GetDanishDayName(day)</option>
                        }
                    </InputSelect>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseChangeDayModal">Annuller</button>
                    <button class="btn btn-primary" @onclick="ConfirmChangeDay">Gem ændring</button>
                </div>
            </div>
        </div>
    </div>
}

@* MODAL: KONTAKT INFO 
   Simpel popup med statiske data om pudseren. *@
@if (showContactInfo)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kontakt Tvilum</h5>
                    <button type="button" class="btn-close" @onclick="() => showContactInfo = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Navn:</strong> Jamie Tvilum</p>
                    <p><strong>Telefon:</strong> 22 34 56 78</p>
                    <p><strong>E-mail:</strong> jamietvilum@gmail.com</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // DATA LISTER: Vi opdeler bookingerne for at gøre UI'et mere overskueligt for kunden
    private List<Booking> previousBookings = new();
    private List<Booking> subscriptionBookings = new();
    private List<Booking> singleBookings = new();
    
    // STATE: Styrer visning af modaler og hvilken booking der arbejdes på
    private bool showCancelModal = false;
    private bool showModalWindows = false;
    private bool showChangeDayModal = false;
    private bool showContactInfo = false;
    private bool showSubscription = false;

    private Booking bookingToCancel;
    private Booking selectedBooking;
    private Booking bookingToChangeDay;
    private DayOfWeek selectedDayOfWeek { get; set; }

    // SERVICE: Injecter interfacet til vores backend-kommunikation
    [Inject] private IBooking bookingService { get; set; }

    // HJÆLPE-METODE: Oversætter Enums til danske navne i UI
    private string GetDanishDayName(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "Mandag", DayOfWeek.Tuesday => "Tirsdag",
            DayOfWeek.Wednesday => "Onsdag", DayOfWeek.Thursday => "Torsdag",
            DayOfWeek.Friday => "Fredag", DayOfWeek.Saturday => "Lørdag",
            DayOfWeek.Sunday => "Søndag", _ => ""
        };
    }

    // NAVIGATION/MODAL LOGIK
    private void OpenModalWindows(Booking b) { selectedBooking = b; showModalWindows = true; }
    private void CloseModalWindows() { showModalWindows = false; }
    private void OpenCancelModal(Booking b) { bookingToCancel = b; showCancelModal = true; }
    private void CloseCancelModal() { showCancelModal = false; }
    private void OpenChangeDayModal(Booking b) { bookingToChangeDay = b; selectedDayOfWeek = b.Date.DayOfWeek; showChangeDayModal = true; }
    private void CloseChangeDayModal() { showChangeDayModal = false; }

    // ALGORITME: Finder den næste korrekte dato baseret på den valgte ugedag
    private async Task ConfirmChangeDay()
    {
        if (bookingToChangeDay == null) return;
        var startDate = DateTime.Today;
        // Udregner differencen i dage mellem i dag og den ønskede ugedag
        int diff = ((int)selectedDayOfWeek - (int)startDate.DayOfWeek + 7) % 7;
        if (diff == 0) diff = 7; // Hvis det er samme dag, rykker vi den en uge frem

        bookingToChangeDay.Date = startDate.AddDays(diff);
        await bookingService.UpdateBooking(bookingToChangeDay); // Gemmer ændringen i databasen

        showChangeDayModal = false;
        StateHasChanged(); // Tvinger Blazor til at re-rendre tabellen
    }

    // DATABASE OPDRATERING: Ændrer status til 'Afmeldt'
    private async Task ConfirmCancelSubscription()
    {
        if (bookingToCancel == null) return;
        bookingToCancel.Status = "Afmeldt";
        await bookingService.UpdateBooking(bookingToCancel);

        // Flytter objektet fra den aktive liste til historikken lokalt i UI
        if (bookingToCancel.TypeBooking == Booking.BookingType.Abonnement)
            subscriptionBookings.Remove(bookingToCancel);
        else
            singleBookings.Remove(bookingToCancel);

        previousBookings.Add(bookingToCancel);
        showCancelModal = false;
    }

    // CSS LOGIK: Returnerer navnet på CSS-klassen baseret på status
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Aktiv" => "status-active", "Godkendt" => "status-approved",
            "Afventer" => "status-pending", "Afvist" => "status-denied",
            "Færdig" => "status-finished", "Afmeldt" => "status-cancelled",
            _ => "status-default"
        };
    }

    // LIFECYCLE: Henter og filtrerer data når siden åbner
    protected override async Task OnInitializedAsync()
    {
        if (userState.CurrentUser == null) return;

        // Henter alle bookinger fra API'et og filtrerer på den loggede kunders unikke ID
        var allBookings = (await bookingService.GetAll())
            .Where(b => b.CustomerId == userState.CurrentUser.Id)
            .ToArray();

        // LINQ: Opdeler data i de tre lister baseret på Type og Status
        subscriptionBookings = allBookings.Where(b => b.TypeBooking == Booking.BookingType.Abonnement && b.Status != "Afmeldt").ToList();
        singleBookings = allBookings.Where(b => b.TypeBooking == Booking.BookingType.EnkeltBooking && b.Status != "Afmeldt" && b.Status != "Færdig").ToList();
        previousBookings = allBookings.Where(b => b.Status == "Afmeldt" || (b.TypeBooking == Booking.BookingType.EnkeltBooking && b.Status == "Færdig")).ToList();

        // Bestemmer hvilken visning kunden møder først
        showSubscription = subscriptionBookings.Any();
    }
}
</div>