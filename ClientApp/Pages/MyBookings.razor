@page "/mybookings"
@using ClientApp.Service
@using Core.Models
@inject UserState userState


<div class="page-wrapper mybookings-page">

<!-- RESTEN AF DIN KODE KOMMER HER -->
@if (!userState.IsLoggedIn) // tjekker om bruger er logget ind
{
    <p>Du skal være logget ind for at se dine bookinger</p>
}
else
{
    @* Hvis brugeren INGEN AKTIVE bookinger har (hverken abonnement eller enkeltbooking) *@
    @if (!subscriptionBookings.Any() && !singleBookings.Any())
    {
        <h3>Bookinger:</h3>
        <p>Du har ingen bookinger tilgængelige endnu.</p>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
        @if (showSubscription)
        {
            <h3>Abonnementer</h3>
        }
        else
        {
            <h3>Dine bookinger</h3>
        }
        <button class="btn btn-info" @onclick="() => showContactInfo = true">
            Info
        </button>
        </div>

        @*viser alle brugerens bookinger*@
        <table class="table tvilum-table">
            <thead class="table-light">
            <tr>
                @if (showSubscription)
                {
                    <th>Dag</th>
                    <th>Næste pudsedato</th>
                }
                else
                {
                    <th>Dato</th>
                }
                <th>Pris</th>
                <th>Status</th>
                @* Inside/Outdoor interval giver kun mening for abonnementer *@
                @if (showSubscription)
                {
                    <th>Indenfor Interval</th>
                    <th>Udenfor Interval</th>
                }
                <th>Kunde kommentar</th>
                <th>Vinduer</th>
                @if (showSubscription)
                {
                    <th>Rediger</th> @* Kun abonnementer kan Rediger *@
                }
                <th>Afmeld</th> @* Afmelding/afbestilling af booking *@
            </tr>
            </thead>

            <tbody>
            @if (showSubscription)
            {
                @* Viser abonnementer *@
                @foreach (var booking in subscriptionBookings)
                {
                    <tr>
                        @* Abonnementets faste dag på ugen *@
                        <td>@booking.Date.ToString("dddd", new System.Globalization.CultureInfo("da-DK"))</td>

                        @* Næste pudsedato *@
                        <td>@booking.Date.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>

                        <td>@booking.Price</td>
                        <td>
                            <span class="status-badge @GetStatusClass(booking.Status)">
                                @booking.Status
                            </span>
                        </td>

                        <td>@booking.InsideJob</td>

                        @if (showSubscription)
                        {
                            <td>@booking.InsideInterval</td>
                            <td>@booking.OutdoorInterval</td>
                        }
                        <td>@booking.NotesCustomer</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                    @onclick="() => OpenModalWindows(booking)">
                                Vis Vinduer
                            </button>
                        </td>
                        @* Kun mulighed for at redgere hvis det er et abonnementet *@
                        @if (showSubscription)
                        {
                            <td>
                                @if (booking.Status == "Aktiv")
                                {
                                    <button class="btn btn-sm btn-outline-secondary"
                                            @onclick="() => OpenChangeDayModal(booking)">
                                        Rediger
                                    </button>
                                }
                            </td>
                        }

                        <td>
                            @* Kun mulighed for at afmelde hvis abonnementet er aktivt *@
                            @if (booking.Status == "Aktiv")
                            {
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => OpenCancelModal(booking)">
                                    Afmeld
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                @* Viser enkeltbookinger *@
                @foreach (var booking in singleBookings)
                {
                    <tr>
                        <td>@booking.Date.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>
                        <td>@booking.Price</td>
                        <td>
                            <span class="status-badge @GetStatusClass(booking.Status)">
                                @booking.Status
                            </span>
                        </td>
                        <td>@booking.InsideJob</td>
                        <td>@booking.NotesCustomer</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                    @onclick="() => OpenModalWindows(booking)">
                                Vis Vinduer
                            </button>
                        </td>
                        <td>
                            @* Afbestil enkeltbooking, hvis den stadig er gældene *@
                            @if (booking.Status == "Aktiv" || booking.Status == "Godkendt" || booking.Status == "Afventer")
                            {
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => OpenCancelModal(booking)">
                                    Afbestil
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    }
}

@*viser indhold under 'tidligere bookinger*@
<h3 class="mt-4">Tidligere bookinger</h3>

@if (previousBookings == null || !previousBookings.Any())
{
    <p>Du har ingen tidligere bookinger.</p>
}
else
{
    <table class="table tvilum-table">
        <thead class="table-light">
        <tr>
            <th>Dato</th>
            <th>Pris</th>
            <th>Status</th>
            <th>Indenfor Interval</th>
            <th>Udenfor Interval</th>
            <th>Kunde kommentar</th>
            <th>Vinduer</th>
        </tr>
        </thead>

        <tbody>
        @foreach (var booking in previousBookings)
        {
            <tr>
                <td>@booking.Date.ToString("dddd-MM-yyyy", new System.Globalization.CultureInfo("da-DK"))</td>
                <td>@booking.Price</td>
                <td>
                            <span class="status-badge @GetStatusClass(booking.Status)">
                                @booking.Status
                            </span>
                </td>
                <td>@booking.InsideJob</td>
                <td>@booking.InsideInterval</td>
                <td>@booking.OutdoorInterval</td>
                <td>@booking.NotesCustomer</td>
                <td>
                    <button class="btn btn-sm btn-primary"
                            @onclick="() => OpenModalWindows(booking)">
                        Vis Vinduer
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@if (showModalWindows)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Vinduer</h5>
                    <button class="btn-close" @onclick="CloseModalWindows"></button>
                </div>
                <div class="modal-body">
                    @if (selectedBooking.Windows != null)
                    {
                        foreach (var window in selectedBooking.Windows)
                        {
                            <li>@window.Type.Name - @window.Location.Name</li>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModalWindows">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showCancelModal)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    @* Afmeld eller afbestil?, kommer an på om der er tale om et abonnement eller enkeltbooking *@
                    @if (bookingToCancel?.TypeBooking == Booking.BookingType.Abonnement)
                    {
                        <h5>Afmeld abonnement</h5>
                    }
                    else
                    {
                        <h5>Afbestil booking</h5>
                    }
                    <button class="btn-close" @onclick="CloseCancelModal"></button>
                </div>

                <div class="modal-body">
                    @if (bookingToCancel?.TypeBooking == Booking.BookingType.Abonnement)
                    {
                        <p>Er du sikker på, at du vil afmelde dit abonnement hos Tvilum?</p>
                    }
                    else
                    {
                        <p>Er du sikker på, at du vil afbestille denne booking hos Tvilum?</p>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseCancelModal">
                        Gå tilbage
                    </button>

                    @if (bookingToCancel?.TypeBooking == Booking.BookingType.Abonnement)
                    {
                        <button class="btn btn-danger" @onclick="ConfirmCancelSubscription">
                            Afmeld
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-danger" @onclick="ConfirmCancelSubscription">
                            Afbestil
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (showChangeDayModal && bookingToChangeDay != null)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5>Rediger ugedag</h5>
                    <button class="btn-close" @onclick="CloseChangeDayModal"></button>
                </div>

                <div class="modal-body">
                    <label>Ny ugedag:</label>
                    <InputSelect @bind-Value="selectedDayOfWeek" class="form-select">
                        @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                        {
                            <option value="@day">@GetDanishDayName(day)</option>
                        }
                    </InputSelect>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseChangeDayModal">
                        Annuller
                    </button>
                    <button class="btn btn-primary" @onclick="ConfirmChangeDay">
                        Gem
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showContactInfo)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Vinduespudser Info</h5>
                    <button type="button" class="btn-close" @onclick="() => showContactInfo = false"></button>
                </div>

                <div class="modal-body">
                    <p><strong>Navn:</strong> Jamie Tvilum</p>
                    <p><strong>Telefon:</strong> 22 34 56 78</p>
                    <p><strong>E-mail:</strong> jamietvilum@gmail.com</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => showContactInfo = false">
                        Luk
                    </button>
                </div>

            </div>
        </div>
    </div>
}


@code {

    // Liste til tidligere bookinger (f.eks. afmeldte abonnementer)
    private List<Booking> previousBookings = new();

    // styrer om "er du sikker?"-modalen for afmeld/afbestil vises
    private bool showCancelModal = false;

    // den booking, der er ved at blive afmeldt/afbestilt af kunden
    private Booking bookingToCancel;

    // Service der henter/gemmer bookinger via API'et.
    [Inject] private IBooking bookingService { get; set; }

    // Liste til alle abonnementer for den aktuelle bruger (aktive i UI)
    private List<Booking> subscriptionBookings = new();

    // Liste til alle enkelt-bookinger for den aktuelle bruger (aktive i UI)
    private List<Booking> singleBookings = new();

    // Array med ALLE bookinger for brugeren - bruges som rå data før filtrering (de bliver fordelt i tre lister - subscription, single og previousBookings)
    private Booking[] bookingArray;

    //Styrer 'vis vinduer' modalen
    private bool showModalWindows = false;
    private Booking selectedBooking;

    // Bestemmer hvilken tabel der skal vises i UI'et.
    // TRUE = vis abonnementer, FALSE = vis enkeltbookinger.
    private bool showSubscription = false;

    // Rediger ugedag (kun abonnement)
    private bool showChangeDayModal = false;
    private Booking bookingToChangeDay;
    private DayOfWeek selectedDayOfWeek { get; set; }

    private string GetDanishDayName(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "Mandag",
            DayOfWeek.Tuesday => "Tirsdag",
            DayOfWeek.Wednesday => "Onsdag",
            DayOfWeek.Thursday => "Torsdag",
            DayOfWeek.Friday => "Fredag",
            DayOfWeek.Saturday => "Lørdag",
            DayOfWeek.Sunday => "Søndag",
            _ => ""
        };
    }

    private void OpenModalWindows(Booking booking)
    {
        selectedBooking = booking;
        showModalWindows = true;
    }


    private void CloseModalWindows()
    {
        showModalWindows = false;
    }

    private void OpenCancelModal(Booking booking)
    {
        bookingToCancel = booking; // gem bookingen, som kunden vil afmelde
        showCancelModal = true; // vis modal
    }

    private void CloseCancelModal()
    {
        showCancelModal = false; // luk modal uden at afmelde
        bookingToCancel = null; // Nulstil – ingen booking er længere valgt til afmelding
    }

    private void OpenChangeDayModal(Booking booking)
    {
        bookingToChangeDay = booking;
        selectedDayOfWeek = booking.Date.DayOfWeek;
        showChangeDayModal = true;
    }

    private void CloseChangeDayModal()
    {
        showChangeDayModal = false;
        bookingToChangeDay = null;
    }

    private async Task ConfirmChangeDay()
    {
        if (bookingToChangeDay == null)
        {
            showChangeDayModal = false;
            return;
        }

        // Udgangspunkt er den nuværende næste pudsedato
        var startDate = bookingToChangeDay.Date.Date;

        // Hvis den af en eller anden grund er i fortiden → brug i dag
        if (startDate < DateTime.Today)
        {
            startDate = DateTime.Today;
        }

        // Beregn hvor mange dage der er til næste ønskede ugedag FRA startdatoen
        int diff = ((int)selectedDayOfWeek - (int)startDate.DayOfWeek + 7) % 7;
        if (diff == 0) diff = 7;

        bookingToChangeDay.Date = startDate.AddDays(diff);

        await bookingService.UpdateBooking(bookingToChangeDay);

        // Opdater UI
        var existing = subscriptionBookings.FirstOrDefault(b => b.Id == bookingToChangeDay.Id);
        if (existing != null)
            existing.Date = bookingToChangeDay.Date;

        showChangeDayModal = false;
        bookingToChangeDay = null;
        StateHasChanged();
    }


    private async Task ConfirmCancelSubscription()
    {
        if (bookingToCancel == null)
        {
            showCancelModal = false;
            return;
        }

        // Kunden er gået igennem med annulleringen  ->  sæt status til “Afmeldt”
        bookingToCancel.Status = "Afmeldt";

        // Gem ændringen i databasen
        await bookingService.UpdateBooking(bookingToCancel);

        // Fjern fra den AKTIVE abonnementsliste i UI (så den forsvinder fra "Dine abonnementer")
        if (bookingToCancel.TypeBooking == Booking.BookingType.Abonnement)
        {
            subscriptionBookings.Remove(bookingToCancel);
        }
        else if (bookingToCancel.TypeBooking == Booking.BookingType.EnkeltBooking)
        {
            singleBookings.Remove(bookingToCancel);
        }

        // Flyt til 'tidligere bookinger', så kunden stadig kan se den
        if (!previousBookings.Contains(bookingToCancel))
        {
            previousBookings.Add(bookingToCancel);
            StateHasChanged(); // sikrer at UI opdateres med det samme
        }

        // Hvis der ikke er flere abonnementer, så skift overskrift til 'dine bookinger' (hvor enkeltbookinger kommer under hvis kunden har nogle
        showSubscription = subscriptionBookings.Any();

        Console.WriteLine($"Abonnement afmeldt for booking: {bookingToCancel.Id}");

        // Luk modal og ryd
        showCancelModal = false;
        bookingToCancel = null;
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Aktiv" => "status-active",
            "Godkendt" => "status-approved",
            "Afventer" => "status-pending",
            "Afvist" => "status-denied",
            "Færdig" => "status-finished",
            "Afmeldt" => "status-cancelled",
            _ => "status-default"
        };
    }

    //Her sker filtreringen
    // Vi henter ALLE bookinger og deler dem op i:
    // - aktive abonnementer
    // - aktive enkeltbookinger
    // - tidligere bookinger
    protected override async Task OnInitializedAsync()
    {
        // Hvis ingen er logget ind, skal vi ikke prøve at hente bookinger
        if (userState.CurrentUser == null)
        {
            bookingArray = Array.Empty<Booking>();
            subscriptionBookings = new List<Booking>();
            singleBookings = new List<Booking>();
            previousBookings = new List<Booking>();
            return;
        }

        bookingArray = (await bookingService.GetAll()) //henter alle bookinger for den aktuelle bruger fra API’et.
            .Where(b => b.CustomerId == userState.CurrentUser.Id) // ← filtrér på den loggede bruger
            .ToArray();

        subscriptionBookings = bookingArray
            .Where(b => b.TypeBooking == Booking.BookingType.Abonnement // Aktive abonnementer, ikke afmeldte
                        && b.Status != "Afmeldt")
            .ToList();


        // Aktive enkeltbooking (ikke afmeldte eller færdige).
        singleBookings = bookingArray
            .Where(b => b.TypeBooking == Booking.BookingType.EnkeltBooking
                        && b.Status != "Afmeldt"
                        && b.Status != "Færdig")
            .ToList();

        // Tidligere bookinger
        // - Alt der er "Afmledt"
        // - Enkeltbookinger der er "Færdig"
        previousBookings = bookingArray
            .Where(b => b.Status == "Afmeldt" ||
                        (b.TypeBooking == Booking.BookingType.EnkeltBooking && b.Status == "Færdig"))
            .ToList();

        // Vælger automatisk hvilken tabel der skal vises:
        // Hvis der er mindst ét abonnement → start med at vise abonnementer
        // Ellers vis enkeltbookinger
        showSubscription = subscriptionBookings.Any();

        // Debugging: skriver alle bookingers ID ud i konsollen.
        foreach (var VARIABLE in bookingArray)
        {
            Console.WriteLine(VARIABLE.Id);
        }
    }
    
    // True = vis kontaktinfo-modal, False = skjul den
    private bool showContactInfo = false;

}
</div>