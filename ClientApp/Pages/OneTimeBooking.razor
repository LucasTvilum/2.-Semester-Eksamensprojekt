@using System.Diagnostics
@using ClientApp.Components
@using Core.Models
@using ClientApp.Service
@using Microsoft.AspNetCore.Components.Forms
@inject IBooking bookingService
@inject IWindow windowService
@inject Blazored.LocalStorage.ILocalStorageService localStorage;
@page "/OneTimeBooking"


<KalenderComponentv2/>
<h3>Midlertidig booking oprettelse</h3>


<EditForm Model="@booking"  OnValidSubmit="@HandleSubmit" class="row p-3">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    
    <div class="col-md-12 mb-3">
        <label for="Name">Noter</label>
        <InputText id="Name" @bind-Value="booking.NotesCustomer" class="form-control" />
    </div>
    
    <div class="col-md-6 mb-3">
        <label for="Price">Pris</label>
        <InputNumber id="Price" @bind-Value="booking.Price" class="form-control" />
    </div>
    
    <div class="col-md-12 mb-3">
        <label for="Category">Dag for pudsning</label>
        <InputSelect id="Category" @bind-Value="booking.Day"> 
            @foreach (var cat in daycategories)
            {
                <option value="@cat">@cat</option>
            }
        </InputSelect>
    </div>
    
    <div class="col-md-12 mb-3">
        <label for="Category">Booking type</label>
        <InputSelect id="type" @bind-Value="booking.TypeBooking"> 
            @foreach (var cat in bookingcategories)
            {
                <option value="@cat">@Booking.GetLabel(cat)</option>
            }
        </InputSelect>
    </div>
    
    <div class="form-check mb-3">
        <InputCheckbox id="Indenfor" @bind-Value="booking.InsideJob" class="form-check-input"/>
        <label class="form-check-label" for="Indenfor">
            Pudsning indenfor
        </label>
    </div>
    
    <div class="form-check mb-3">
        <InputCheckbox id="Udenfor" @bind-Value="booking.InsideJob" class="form-check-input"/>
        <label class="form-check-label" for="Udenfor">
            Pudsning udenfor
        </label>
    </div>
    
    <div class="col-12 mb-3">
        <button type="submit" class="btn btn-primary" >Opret Booking</button>
    </div>
    
    <div class="col-12 mb-3">
        <button type="reset" class="btn btn-primary">Reset</button>
    </div>
    
</EditForm> 

<EditForm Model="@window"  OnValidSubmit="@HandleWindowSubmit" class="row p-3">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <div class="col-md-12 mb-3">
        <label for="Category">Vindue Type</label>
        <InputSelect id="Type" @bind-Value="window.Type">
            @foreach (var type in windowtypecategories)
            {
                <option value="@type">@type.Name</option>
            }
        </InputSelect>
    </div>
    
    <div class="col-md-12 mb-3">
        <label for="Category">Vindue lokation</label>
        <InputSelect id="Location" @bind-Value="window.Location">
            @foreach (var location in windowlocationcategories)
            {
                <option value="@location">@location.Name</option>
            }
        </InputSelect>
    </div>
    
    <div class="col-12 mb-3">
        <button type="submit" class="btn btn-primary" >Tilføj vindue</button>
    </div>
    
    <div class="col-12 mb-3">
        <button type="reset" class="btn btn-primary">Reset</button>
    </div>
    
</EditForm> 

@code {
    
    private User currentUser = new User();
    
    private Booking booking = new();
    
    private WorkTask worktask = new();
    
    private List<string> daycategories = new List<string> { "Mandag","Tirsdag","Onsdag","Torsdag","Fredag","Lørdag","Søndag" };
    
    private List<Booking.BookingType> bookingcategories = new List<Booking.BookingType> { Booking.BookingType.Abonnement , Booking.BookingType.EnkeltBooking};
    
    private bool showModalBooking = false;
    
    private async Task HandleSubmit()
    {
        worktask.BookingId = booking.Id;
        worktask.InsideJob = booking.InsideJob;
        worktask.Date = new DateTime(2025, 12, 1, 14, 30, 0);
        worktask.Worker = new Worker
        {
            Username = "lucas",
            Password = "Lucas",
            Admin = true,
            Name = "lucas",
            PhoneNumber = "123123",
            Mail = "lucas@mail.com"
        };
        
        // Sæt den loggede bruger som ejer af enkeltbooking
        booking.CustomerId = currentUser.Id;
        
        // Markér som et enkeltbooking
        booking.TypeBooking = Booking.BookingType.EnkeltBooking;
        
        // Status for nye enkeltbookinger
        booking.Status = "Aktiv";
        Console.WriteLine("handle submit – enkeltbooking for kunde: " + booking.CustomerId);
        
        // Gem booking
        await bookingService.Add(booking);
        
        showModalBooking = true;
        
        // Reset booking-objektet
        booking = new Booking();
        worktask = new WorkTask();
    }

    private List<WindowType> windowtypecategories = new List<WindowType>();
    private List<WindowLocation> windowlocationcategories = new List<WindowLocation>();
    WindowType windowtypes;
    WindowLocation windowlocations;
    
    private Window window = new Window
    {
        Type = new WindowType(),
        Location = new WindowLocation(),
        Price = 12000
    };
    
    protected override async Task OnInitializedAsync()
    {
        var loadedUser = await localStorage.GetItemAsync<User>("currentUser");

        if (loadedUser != null && loadedUser.Usertype != User.UserType.User)
        {
            Console.WriteLine("local storage succesfuld");
            Console.WriteLine("loaded bruger type: " + User.GetLabel(loadedUser.Usertype));
            currentUser = loadedUser;
        }
        
        Console.WriteLine("bruger type (OneTimeBooking): " + User.GetLabel(currentUser.Usertype));
        
        windowtypecategories = await windowService.GetAllWindowTypes();
        windowlocationcategories = await windowService.GetAllWindowLocations(); 
        var savedBooking = await localStorage.GetItemAsync<Booking>("pendingBooking");
        if (savedBooking != null)
        {
            booking = savedBooking;
        }
    }

    
    private async Task HandleWindowSubmit()
    {
        window.Price = window.CalculatePrice();
        booking.Windows.Add(window);
        window = new Window();    
    }
}